<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<title>수학여행 채팅</title>
<script src="/socket.io/socket.io.js"></script>
<link href="https://hangeul.pstatic.net/hangeul_static/css/nanum-square-neo.css" rel="stylesheet">
<style>
    * {
      margin: 0;
      padding: 0;
      border: none;
      font-family: 'NanumSquareNeoBold';
    }
    #loginDiv {
      width: 80dvw;
      height: 35dvh;
      margin-left: 5dvw;
      margin-right: 5dvw;
      margin-top: 27.5dvh;
      margin-bottom: 27.5dvh;
      padding: 5dvw;
      background-color: oklab(94.54599999999999% -0.07853 0.01077);
      border-radius: 5dvh;
      display: flex;
      flex-direction: column;
      justify-content: flex-start;
      align-items: center;
    }
    #loginDiv h2 {
      font-size: 2.5dvw;
      text-align: center;
      margin-top: 2dvh;
      margin-bottom: 2dvh;
      font-family: 'NanumSquareNeoExtraBold';
    }
    .login_in {
      width: 30dvw;
      height: 5dvh;
      border-radius: 2.5dvh;
      padding-left: 2.5dvh;
      padding-right: 2.5dvh;
      background-color: oklab(91.501% -0.128 0.0248);
    }
    #loginBtn {
      width: 40dvw;
      height: 7.5dvh;
      border-radius: calc(7.5dvh / 2);
      background-color: oklab(90.77499999999999% -0.14859 0.1261);
    }
    #loginBtn, #sendBtn, #logoutBtn, #enableNotiBtn {
      font-size: 1rem;
      max-width: 400px;
      width: 100%;
      cursor: pointer;
    }
    #chatDiv {
      width: 80dvw;
      height: 80dvh;
      margin-left: 5dvw;
      margin-right: 5dvw;
      margin-top: 5dvh;
      margin-bottom: 5dvh;
      background-color: oklab(94.54599999999999% -0.07853 0.01077);
      border-radius: 5dvh;
      padding-left: 5dvw;
      padding-right: 5dvw;
      padding-top: 5dvh;
      padding-bottom: 5dvh;
      display: flex;
      flex-direction: column;
      justify-content: flex-start;
      align-items: stretch;
    }
    #chatDiv h2 {
      font-size: 2.5dvw;
      text-align: center;
      margin-top: 2dvh;
      margin-bottom: 2dvh;
      font-family: 'NanumSquareNeoExtraBold';
    }
    .mine, .other {
      width: 57.5dvw;
      min-height: 10dvh;
      height: fit-content;
      margin-top: 0.5dvw;
      margin-bottom: 1.5dvw;
    }
    .mine {
      margin-left: 20dvw;
      padding-right: 2.5dvw;
      display: flex;
      flex-direction: column;
      align-items: flex-end;
      justify-content: center;
    }
    .other {
      margin-right: 20dvw;
      padding-left: 2.5dvw;
      display: flex;
      flex-direction: column;
      align-items: flex-start;
      justify-content: center;
    }
    .mine .msg {
      padding: 2dvw;
      border-radius: 2dvw;
      background-color: oklab(60.875% -0.12848 0.0448);
      color: white;
    }
    .other .msg {
      padding: 2dvw;
      border-radius: 2dvw;
      background-color: oklab(91.556% -0.03827 0.00398);
      color: black;
    }
    .mine .name {
      color: #7a7a7a;
      margin-right: 0.75dvw;
    }
    .other .name {
      color: #7a7a7a;
      margin-left: 0.75dvw;
    }
    .mine .time {
      font-size: x-small;
      margin-left: 0.75dvw;
    }
    .other .time {
      font-size: x-small;
      margin-right: 0.75dvw;
    }
    #chatBox {
      width: 80dvw;
      overflow-y: scroll;
      overflow-x: hidden;
      flex: 1; /* 남은 공간만 차지하도록 */
      min-height: 0; /* flex overflow 방지 */
    }
    #chatBox::-webkit-scrollbar {
      width: 1dvw;
      height: 20dvh;
    }
    #chatBox::-webkit-scrollbar-thumb {
      background: oklab(70.824% -0.11927 0.02428); /* 스크롤바 막대 색상 */
      border: 2px solid oklab(63.425% -0.09914 0.01892); /* 스크롤바 막대 테두리 설정  */
      border-radius: 1dvw;
    }
    #chatBox::-webkit-scrollbar-track {
      background: oklab(85.58099999999999% -0.10751 0.01707); /* 스크롤바 뒷 배경 색상 */
      border-radius: 0.5dvw;
    }
    #msg {
      width: 67.5dvw;
      height: 5dvh;
      border-radius: 2.5dvh 0 0 2.5dvh;
      padding-left: 2.5dvw;
      background-color: oklab(98.41499999999999% -0.02164 0.003);
    }
    #sendBtn {
      width: 10dvw;
      height: 5dvh;
      border-radius: 0 2.5dvh 2.5dvh 0;
      background-color: oklab(85.58099999999999% -0.10751 0.01707);
    }
    #msgDiv {
      font-size: 0;
      line-height: 0;
    }
    #logoutBtn {
      width: 80dvw;
      height: 5dvh;
      background-color: oklab(69.017% 0.14818 0.06027);
      border-radius: 2.5dvh;
      margin-top: 1.5dvh;
    }
    #users {
      width: 80dvw;
      height: 10dvh;
      display: grid;
      grid-template-columns: repeat(8, 1fr);
      grid-template-rows: repeat(3, 1fr);
    }
    #users label {
      width: 5em;
    }
    #msgModal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.5);
      justify-content: center;
      align-items: center;
    }
    #msgModal > div {
      background: white;
      padding: 2vh 2vw;
      border-radius: 2vw;
      max-width: 90vw;
      width: 90vw;
      box-shadow: 0 1vh 2vh rgba(0,0,0,0.3);
      position: relative;
    }
    #modalClose {
      position: absolute;
      top: 1vh;
      right: 2vw;
      cursor: pointer;
      font-weight: bold;
      font-size: 5vw;
    }
    #msgModal h3 {
      margin-top: 0;
      margin-bottom: 1vh;
    }
    #msgModal p {
      margin: 0.5vh 0;
    }
    #enableNotiBtn {
        height: 5dvh;
        background-color: #5cb85c;
        border-radius: 2.5dvh;
        color: white;
        margin-bottom: 1.5dvh;
    }

    @media (min-width: 767px){
      * {
        margin: 0;
        padding: 0;
        border: none;
        font-family: 'NanumSquareNeoBold';
      }
      #loginDiv {
        width: 80dvw;
        height: 35dvh;
        margin-left: 5dvw;
        margin-right: 5dvw;
        margin-top: 27.5dvh;
        margin-bottom: 27.5dvh;
        padding: 5dvw;
        background-color: oklab(94.54599999999999% -0.07853 0.01077);
        border-radius: 5dvh;
        display: flex;
        flex-direction: column;
        justify-content: flex-start;
        align-items: center;
      }
      #loginDiv h2 {
        font-size: 5dvw;
        text-align: center;
        margin-top: 2dvh;
        margin-bottom: 2dvh;
        font-family: 'NanumSquareNeoExtraBold';
      }
      .login_in {
        width: 30dvw;
        height: 5dvh;
        border-radius: 2.5dvh;
        padding-left: 2.5dvh;
        padding-right: 2.5dvh;
        background-color: oklab(91.501% -0.128 0.0248);
        font-size: xx-large;
      }
      #loginBtn {
        width: 40dvw;
        height: 7.5dvh;
        border-radius: calc(7.5dvh / 2);
        background-color: oklab(90.77499999999999% -0.14859 0.1261);
        font-size: xx-large;
      }
      #chatDiv {
        width: 100dvw;
        height: 100dvh;

        border-radius: 0;
        padding-left: 1dvw;
        padding-right: 1dvw;
        padding-top: 1dvh;
        padding-bottom: 1dvh;

        margin: 0;
        border-radius: 0;
      }
      #chatDiv h2 {
        font-size: 5dvw;
      }
      .mine, .other {
        width: 55dvw;
        min-height: 5dvh;
        height: fit-content;
        margin-top: 0.5dvw;
        margin-bottom: 1.5dvw;
      }
      .mine {
        margin-left: 40dvw;
        padding-right: 5dvw;
      }
      .other {
        margin-right: 40dvw;
        padding-left: 2.5dvw;
      }
      .mine .msg {
        padding: 3dvw;
        border-radius: 4dvw;
        font-size: xx-large;
      }
      .other .msg {
        padding: 3dvw;
        border-radius: 4dvw;
        font-size: xx-large;
      }
      .mine .name {
        font-size: xx-large;
      }
      .other .name {
        font-size: xx-large;
      }
      .mine .time {
        font-size: large;
      }
      .other .time {
        font-size: large;
      }
      #chatBox {
        width: 100dvw;
        flex: 1; /* 남은 공간만 차지하도록 */
        min-height: 0; /* flex overflow 방지 */
      }
      #chatBox::-webkit-scrollbar {
        width: 2.5dvw;
      }
      #chatBox::-webkit-scrollbar-thumb {
        border-radius: calc(2.5dvw/2);
      }
      #chatBox::-webkit-scrollbar-track {
        border-radius: calc(2.5dvw/2);
      }
      #msg {
        width: 77.5dvw;
        height: 5dvh;

        font-size: xx-large;
      }
      #sendBtn {
        width: 20dvw;

        font-size: xx-large;
      }
      #users {
        width: 80dvw;
        height: 10dvh;
        display: grid;
        grid-template-columns: repeat(8, 1fr);
        grid-template-rows: repeat(3, 1fr);
      }
      #users label {
        width: 5em;
        font-size: x-large;
      }
      .userChk {
        width: 2.5em;
        height: 2.5em;
      }
      #msgModal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0,0,0,0.5);
        justify-content: center;
        align-items: center;
      }
      #msgModal > div {
        background: white;
        padding: 2vh 2vw;
        border-radius: 2vw;
        max-width: 90vw;
        width: 90vw;
        box-shadow: 0 1vh 2vh rgba(0,0,0,0.3);
        position: relative;
      }
      #modalClose {
        position: absolute;
        top: 1vh;
        right: 2vw;
        cursor: pointer;
        font-weight: bold;
        font-size: 5vw;
      }
      #msgModal h3 {
        margin-top: 0;
        margin-bottom: 1vh;
      }
      #msgModal p {
        margin: 0.5vh 0;
      }
      #enableNotiBtn {
          height: 5dvh;
          background-color: #5cb85c;
          border-radius: 2.5dvh;
          color: white;
          margin-bottom: 1.5dvh;
      }
    }
</style>
</head>
<body>

<div id="loginDiv">
  <h2>로그인</h2>
  <input class="login_in" type="text" id="id" placeholder="아이디"><br>
  <input class="login_in" type="password" id="pw" placeholder="비밀번호"><br>
  <button id="loginBtn">Login</button>
</div>

<div id="chatDiv" style="display:none;">
  <h2>채팅방</h2>
  <button id="enableNotiBtn">알림 활성화</button>
  <div id="users"></div>
  <div id="chatBox"></div>
  <div id="msgDiv">
    <input type="text" id="msg" placeholder="메시지 입력...">
    <button id="sendBtn">전송</button>
  </div>
  <button id="logoutBtn">로그아웃</button>
</div>

<div id="msgModal">
  <div>
    <span id="modalClose">×</span>
    <h3>상세 정보</h3>
    <p id="modalFrom"></p>
    <p id="modalMsg"></p>
    <p id="modalTo"></p>
  </div>
</div>

<script>
    document.addEventListener("DOMContentLoaded", () => {
        const socket = io.connect(window.location.origin, { path: "/socket.io", transports: ['websocket'] });

        let id = localStorage.getItem("id");
        let name = localStorage.getItem("name");
        let num = localStorage.getItem("num") !== null ? Number(localStorage.getItem("num")) : null;

        const loginDiv = document.getElementById("loginDiv");
        const chatDiv = document.getElementById("chatDiv");
        const chatBox = document.getElementById("chatBox");
        const usersDiv = document.getElementById("users");
        const msgInput = document.getElementById("msg");
        const enableNotiBtn = document.getElementById("enableNotiBtn");
        const msgModal = document.getElementById("msgModal");
        const modalClose = document.getElementById("modalClose");
        modalClose.addEventListener("click", () => msgModal.style.display = "none");
        msgModal.addEventListener("click", e => { if (e.target.id === "msgModal") msgModal.style.display = "none"; });

        function urlBase64ToUint8Array(base64String) {
            const padding = "=".repeat((4 - base64String.length % 4) % 4);
            const base64 = (base64String + padding).replace(/\-/g, "+").replace(/_/g, "/");
            const rawData = window.atob(base64);
            const outputArray = new Uint8Array(rawData.length);
            for (let i = 0; i < rawData.length; ++i) {
                outputArray[i] = rawData.charCodeAt(i);
            }
            return outputArray;
        }

        async function initPush() {
            if (!('serviceWorker' in navigator && 'PushManager' in window)) {
                enableNotiBtn.style.display = 'none';
                return;
            }
            const registration = await navigator.serviceWorker.register('/sw.js');
            if (Notification.permission === 'granted') {
                enableNotiBtn.style.display = 'none';
                if (num !== null) subscribeUser(registration);
            } else if (Notification.permission === 'denied') {
                enableNotiBtn.innerText = '알림 차단됨 (브라우저 설정 변경 필요)';
                enableNotiBtn.disabled = true;
            } else {
                enableNotiBtn.style.display = 'block';
            }
        }

        async function subscribeUser(registration) {
            try {
                let subscription = await registration.pushManager.getSubscription();
                if (subscription === null) {
                    const vapidPublicKey = "BA8aLGnr2aXd8qSCVirpsD_2RtCvPSaGOSvCapRulSNBf3IjrnOyklBDxy3LsU5gzxTOXuUR50uCLWRWhpMZcvw";
                    const convertedVapidKey = urlBase64ToUint8Array(vapidPublicKey);
                    subscription = await registration.pushManager.subscribe({
                        userVisibleOnly: true,
                        applicationServerKey: convertedVapidKey
                    });
                }
                await fetch('/save-subscription', {
                    method: 'POST',
                    body: JSON.stringify({ num, subscription }),
                    headers: { 'Content-Type': 'application/json' }
                });
                enableNotiBtn.style.display = 'none';
            } catch (error) {
                console.error('푸시 구독 실패:', error);
            }
        }
        initPush();

        enableNotiBtn.addEventListener('click', async () => {
            const permission = await Notification.requestPermission();
            if (permission === 'granted') {
                initPush();
            }
        });

        const renderUserSelect = () => {
            if (num !== 0) { usersDiv.style.display = 'none'; return; }
            usersDiv.style.display = 'grid';
            const students = [
                {num:1,name:"김민찬"},{num:2,name:"김소영"},{num:3,name:"김예나"},{num:4,name:"김예인"},{num:5,name:"김유진"},{num:6,name:"김하진"},
                {num:7,name:"문승민"},{num:8,name:"민채아"},{num:9,name:"변가연"},{num:10,name:"변승규"},{num:11,name:"서지아"},{num:12,name:"양혜주"},
                {num:13,name:"우승기"},{num:14,name:"이도윤"},{num:15,name:"이용우"},{num:16,name:"이재아"},{num:17,name:"이한별"},{num:18,name:"이현"},
                {num:19,name:"이현령"},{num:20,name:"장의찬"},{num:21,name:"장준혁"},{num:22,name:"최재인"},{num:23,name:"최해율"},{num:24,name:"홍지우"}
            ];
            usersDiv.innerHTML = '';
            students.forEach(s => {
                const label = document.createElement("label");
                const chk = document.createElement("input");
                chk.type = "checkbox"; chk.className = "userChk"; chk.dataset.num = s.num; chk.dataset.name = s.name;
                label.appendChild(chk); label.appendChild(document.createTextNode(s.name + " "));
                usersDiv.appendChild(label);
            });
        };

        const formatTime = (ts) => {
            if (!ts) return '';
            const date = new Date(ts);
            return date.toLocaleTimeString("ko-KR", { hour: "2-digit", minute: "2-digit", hour12: true });
        };

        const addMessage = (data) => {
            const div = document.createElement("div");
            div.className = data.fromNum === num ? "mine" : "other";
            const time = formatTime(data.timestamp);
            div.innerHTML = `
                <div class="name">${data.fromNum === num ? "나" : data.fromName}</div>
                <div class="msg">${data.msg}</div>
                <div class="time">${time}</div>`;
            
            div.addEventListener("click", () => {
                let toNameArray = data.toName;
                if (typeof toNameArray === 'string' && toNameArray.startsWith('[')) {
                    try { toNameArray = JSON.parse(toNameArray); } catch(e) {}
                }
                let toStr = Array.isArray(toNameArray) ? toNameArray.join(", ") + ` (총 ${toNameArray.length}명)` : toNameArray;
                document.getElementById("modalFrom").innerText = `보낸 사람: ${data.fromName}`;
                document.getElementById("modalMsg").innerText = `메시지: ${data.msg}`;
                document.getElementById("modalTo").innerText = `받는 사람: ${toStr}`;
                msgModal.style.display = "flex";
            });

            chatBox.appendChild(div);
            chatBox.scrollTop = chatBox.scrollHeight;
        };

        const handleLoginSuccess = (data) => {
            localStorage.setItem("id", data.id);
            localStorage.setItem("name", data.name);
            localStorage.setItem("num", data.num);
            id = data.id; name = data.name; num = Number(data.num);
            loginDiv.style.display = "none";
            chatDiv.style.display = "flex";
            renderUserSelect();
            socket.emit("load_chat", num);
            initPush();
        };

        if (id && name && num !== null) {
            socket.emit("relogin", { id, name, num });
            handleLoginSuccess({ id, name, num });
        }

        document.getElementById("loginBtn").addEventListener("click", () => {
            const inputId = document.getElementById("id").value.trim();
            const inputPw = document.getElementById("pw").value.trim();
            if (inputId && inputPw) {
                socket.emit("login", JSON.stringify({ id: inputId, pw: inputPw }));
            }
        });

        document.getElementById("logoutBtn").addEventListener("click", () => {
            localStorage.clear();
            window.location.reload();
        });

        const sendMessage = () => {
            const msg = msgInput.value.trim();
            if (!msg) return;
            let targets = [];
            if (num === 0) {
                document.querySelectorAll('.userChk:checked').forEach(chk => {
                    targets.push({ num: Number(chk.dataset.num), name: chk.dataset.name });
                });
                if (targets.length === 0) { alert('전송 대상을 선택하세요.'); return; }
            } else {
                targets.push({ num: 0, name: "선생님" });
            }
            const toNums = targets.map(t => t.num);
            const toNames = targets.map(t => t.name);
            socket.emit("chat", { fromNum: num, fromName: name, toNum: toNums, toName: toNames, msg });
            msgInput.value = "";
        };

        document.getElementById("sendBtn").addEventListener("click", sendMessage);
        msgInput.addEventListener("keypress", (e) => { if (e.key === "Enter") sendMessage(); });

        socket.on("login_s", res => {
            const data = JSON.parse(res);
            if (data.status === "ok") handleLoginSuccess(data);
            else alert("로그인 실패! 아이디와 비밀번호를 확인해주세요.");
        });

        socket.on("chat_history", rows => {
            chatBox.innerHTML = '';
            rows.forEach(row => {
                row.timestamp = row.timestamp ? new Date(row.timestamp.replace(' ', 'T')) : new Date();
                addMessage(row);
            });
        });

        socket.on("chat", data => {
            data.timestamp = new Date();
            addMessage(data);
        });
    });
</script>
</body>
</html>