<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<title>수학여행 채팅</title>
<script src="/socket.io/socket.io.js"></script>
<link href="https://hangeul.pstatic.net/hangeul_static/css/nanum-square-neo.css" rel="stylesheet">
<style>
  *{margin:0;padding:0;border:none;font-family:'NanumSquareNeoBold';}
  #loginDiv{width:80dvw;height:35dvh;margin:27.5dvh 5dvw; padding:5dvw;background:oklab(94.546% -0.079 0.011);border-radius:5dvh;display:flex;flex-direction:column;justify-content:flex-start;align-items:center;}
  #loginDiv h2{font-size:2.5dvw;text-align:center;margin:2dvh 0;font-family:'NanumSquareNeoExtraBold';}
  .login_in{width:30dvw;height:5dvh;border-radius:2.5dvh;padding-left:2.5dvh;background:oklab(91.501% -0.128 0.0248);}
  #loginBtn{width:40dvw;height:7.5dvh;border-radius:calc(7.5dvh/2);background:oklab(90.775% -0.149 0.126);}
  #chatDiv{width:80dvw;height:90dvh;margin:5dvh 5dvw;background:oklab(94.546% -0.079 0.011);border-radius:5dvh;padding:5dvw;display:flex;flex-direction:column;align-items:stretch;}
  #chatDiv h2{font-size:2.5dvw;text-align:center;margin:2dvh 0;font-family:'NanumSquareNeoExtraBold';}
  #chatBox{width:80dvw;height:60dvh;overflow-y:scroll;overflow-x:hidden;}
  #chatBox::-webkit-scrollbar{width:1dvw;}
  #chatBox::-webkit-scrollbar-thumb{background:oklab(70.824% -0.119 0.024);border:2px solid oklab(63.425% -0.099 0.019);border-radius:12px;}
  #chatBox::-webkit-scrollbar-track{background:oklab(85.581% -0.108 0.017);border-radius:0.5dvw;}
  .mine,.other{width:57.5dvw;min-height:10dvh;margin:0.5dvw 0 1.5dvw;}
  .mine{margin-left:20dvw;padding-right:2.5dvw;display:flex;flex-direction:column;align-items:flex-end;}
  .other{margin-right:20dvw;padding-left:2.5dvw;display:flex;flex-direction:column;align-items:flex-start;}
  .mine .msg{padding:2dvw;border-radius:2dvw;background:oklab(60.876% -0.128 0.045);color:white;}
  .other .msg{padding:2dvw;border-radius:2dvw;background:oklab(91.556% -0.038 0.004);color:black;}
  .mine .name{color:#7a7a7a;margin-right:0.75dvw;}
  .other .name{color:#7a7a7a;margin-left:0.75dvw;}
  .mine .time,.other .time{font-size:x-small;}
  #msgDiv{font-size:0;line-height:0;display:flex;margin-top:1dvh;}
  #msg{flex:1;height:5dvh;border-radius:2.5dvh 0 0 2.5dvh;padding-left:2.5dvw;background:oklab(98.415% -0.022 0.003);}
  #sendBtn{width:10dvw;height:5dvh;border-radius:0 2.5dvh 2.5dvh 0;background:oklab(85.581% -0.108 0.017);}
  #logoutBtn{width:80dvw;height:5dvh;background:oklab(69.017% 0.148 0.060);border-radius:2.5dvh;margin-top:1dvh;}
  #users{width:80dvw;height:10dvh;display:grid;grid-template-columns:repeat(8,1fr);grid-template-rows:repeat(3,1fr);}
  #users label{display:inline-block;width:5em;}
  /* 모달 */
  #msgModal{display:none;position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.5);justify-content:center;align-items:center;}
  #msgModal>div{background:white;padding:2vh 2vw;border-radius:2vw;max-width:90vw;width:90vw;box-shadow:0 1vh 2vh rgba(0,0,0,0.3);position:relative;}
  #modalClose{position:absolute;top:1vh;right:2vw;cursor:pointer;font-weight:bold;font-size:4dvw;}
  #msgModal h3{margin-top:0;margin-bottom:1vh;}
  #msgModal p{margin:0.5vh 0;}
</style>
</head>
<body>
<div id="loginDiv">
  <h2>로그인</h2>
  <input class="login_in" type="text" id="id" placeholder="아이디"><br>
  <input class="login_in" type="password" id="pw" placeholder="비밀번호"><br>
  <button id="loginBtn">Login</button>
</div>

<div id="chatDiv" style="display:none;">
  <h2>채팅방</h2>
  <div id="users"></div>
  <div id="chatBox"></div>
  <div id="msgDiv">
    <input type="text" id="msg" placeholder="메시지 입력...">
    <button id="sendBtn">전송</button>
  </div>
  <button id="logoutBtn">로그아웃</button>
</div>

<div id="msgModal">
  <div>
    <span id="modalClose">×</span>
    <h3>상세 정보</h3>
    <p id="modalFrom"></p>
    <p id="modalMsg"></p>
    <p id="modalTo"></p>
  </div>
</div>

<script>
document.addEventListener("DOMContentLoaded", ()=>{
  const host = window.location.origin;
  const socket = io.connect(host, {path:"/socket.io",transports:['websocket']});
  let auth = localStorage.getItem("auth");
  let id = localStorage.getItem("id");
  let name = localStorage.getItem("name");
  let num = Number(localStorage.getItem("num"));

  const loginDiv = document.getElementById("loginDiv");
  const chatDiv = document.getElementById("chatDiv");
  const chatBox = document.getElementById("chatBox");
  const usersDiv = document.getElementById("users");

  const msgModal = document.getElementById("msgModal");
  const modalClose = document.getElementById("modalClose");
  modalClose.addEventListener("click", ()=>msgModal.style.display="none");
  msgModal.addEventListener("click", e=>{ if(e.target.id==="msgModal") msgModal.style.display="none"; });

  function renderUserSelect(){
    if(num!==0) return;
    const students = [
      {num:1,name:"김민찬"},{num:2,name:"김소영"},{num:3,name:"김예나"},
      {num:4,name:"김예인"},{num:5,name:"김유진"},{num:6,name:"김하진"},
      {num:7,name:"문승민"},{num:8,name:"민채아"},{num:9,name:"변가연"},
      {num:10,name:"변승규"},{num:11,name:"서지아"},{num:12,name:"양혜주"},
      {num:13,name:"우승기"},{num:14,name:"이도윤"},{num:15,name:"이용우"},
      {num:16,name:"이재아"},{num:17,name:"이한별"},{num:18,name:"이현"},
      {num:19,name:"이현령"},{num:20,name:"장의찬"},{num:21,name:"장준혁"},
      {num:22,name:"최재인"},{num:23,name:"최해율"},{num:24,name:"홍지우"}
    ];
    students.forEach(s=>{
      const label=document.createElement("label");
      const chk=document.createElement("input");
      chk.type="checkbox"; chk.className="userChk"; chk.dataset.num=s.num; chk.dataset.name=s.name;
      label.appendChild(chk); label.appendChild(document.createTextNode(s.name+" "));
      usersDiv.appendChild(label);
    });
  }

  function parseKST(ts){
    if(!ts) return new Date();
    const [d,t]=ts.split(' '); const [y,m,d1]=d.split('-').map(Number); const [h,min,s]=t.split(':').map(Number);
    return new Date(y,m-1,d1,h,min,s);
  }

  function addMessage(data){
    // 학생 → 학생 메시지 차단
    if(data.fromNum !== 0 && Array.isArray(data.toNum) && data.toNum.some(n => n !== 0)){
      return; // 메시지 표시 안함
    }

    const div = document.createElement("div");
    div.className = "msg " + (data.fromNum===num?"mine":"other");
    const date = parseKST(data.timestamp);
    const time = date.toLocaleTimeString('ko-KR',{hour:'2-digit',minute:'2-digit',hour12:true});

    div.innerHTML = `
      <div class="name">${data.fromNum===num?"나":data.fromName}</div>
      <div class="msg">${data.msg}</div>
      <div class="time">${time}</div>
    `;

    div.addEventListener("click", ()=>{
      let toStr = Array.isArray(data.toName)?data.toName.join(", ") + ` (총 ${data.toName.length}명)`:data.toName;
      document.getElementById("modalFrom").innerText=`보낸 사람: ${data.fromName}`;
      document.getElementById("modalMsg").innerText=`메시지: ${data.msg}`;
      document.getElementById("modalTo").innerText=`받는 사람: ${toStr}`;
      msgModal.style.display="flex";
    });

    chatBox.appendChild(div);
    chatBox.scrollTop = chatBox.scrollHeight;
  }


  if(auth==="true"){ loginDiv.style.display="none"; chatDiv.style.display="flex"; renderUserSelect(); socket.emit("load_chat", num); }

  document.getElementById("loginBtn").addEventListener("click", ()=>{
    const inputId=document.getElementById("id").value;
    const inputPw=document.getElementById("pw").value;
    socket.emit("login", JSON.stringify({id:inputId,pw:inputPw}));
    socket.once("login_s", res=>{
      const data=JSON.parse(res);
      if(data.status==="ok"){
        localStorage.setItem("auth","true");
        localStorage.setItem("id",data.id);
        localStorage.setItem("name",data.name);
        localStorage.setItem("num",data.num);
        id=data.id; name=data.name; num=Number(data.num);
        loginDiv.style.display="none"; chatDiv.style.display="flex";
        renderUserSelect(); socket.emit("load_chat", num);
      }else alert("로그인 실패!");
    });
  });

  document.getElementById("logoutBtn").addEventListener("click", ()=>{ localStorage.clear(); location.reload(); });

  document.getElementById("sendBtn").addEventListener("click", ()=>{
    const msg=document.getElementById("msg").value.trim(); if(!msg) return;
    let targets=[];
    if(num===0){ // 선생님
      document.querySelectorAll('.userChk:checked').forEach(chk=>{
        targets.push({toNum:Number(chk.dataset.num), toName:chk.dataset.name});
      });
    }else{ // 학생
      targets.push({toNum:0,toName:"선생님"});
    }
    const toNums=targets.map(t=>t.toNum);
    const toNames=targets.map(t=>t.toName);
    socket.emit("chat",{fromId:id,fromName:name,fromNum:num,toNum:toNums,toName:toNames.length>1?toNames:toNames[0],msg});
    document.getElementById("msg").value="";
  });

  socket.on("chat_history", rows=>{ rows.forEach(d=>addMessage(d) )});
  socket.on("chat", data=>{
    // 학생→학생 메시지 차단
    if(data.fromNum!==0 && data.toNum.some(n=>n!==0)) return;
    if(data.toNum.includes(num)||data.fromNum===num||data.toNum===0){ addMessage(data);
      if(data.fromNum!==num && Notification.permission==='granted') new Notification(`새 메시지: ${data.fromName}`,{body:data.msg});
    }
  });
});
</script>
</body>
</html>
